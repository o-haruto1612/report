## 3. Mastodonの構造
mastodonとは、の説明やデバッグの説明でも少し出てきているかもしれませんがここでmastodonの構造を簡単に説明しておきます。

mastodonは分散型のサーバーを持っているSNSです。そのため別々のサーバーがあってその中身が存在しており、その中でユーザーがやりとりをすることができますが、サーバー間を超えて通信することも可能になっています。


写真を挿入。

一つのサーバーにつき、フロントエンド、バックエンド、データサーバーが存在し、これらをまとめてインスタンスと呼びます。このインスタンス同士のやりとりについてはActivityPubによって行っていますが、ここでは説明しません。

mastodonに用いられている言語を並べると、
・Ruby
・Javascript
・Haml
・SCSS
・TypeScript
・HTML

以上のものが含まれています。
この中で聞き慣れなかったものとしてはHamlファイルが一番でした。これは他にもerb(embedded Ruby)も同じような役割を担うものとして存在していますが、これはHTMLなどのテキストにRubyのスクリプトを埋め込むためのライブラリです。Hamlはerbよりもシンプルに書くことができますが、なれるのには少し時間がかかるかもしれません。

SCSSも今回ソースコードを眺めていて初めて見かけたものでしたが、名前の通り、CSSと近いものになっています。インターネットのページの色やレイアウトを決めるCSSをより手軽にかけるようにしたものです。mastodonのホーム画面についてもこれが用いられています。

また難しかったものとしてはRuby on Railsがあります。これはより簡単にかけるようにしてくれている一方でファイル同士のつながりが見えづらくなってしまうように感じました。今回の実験でもこれによって関数を探るのが難しかった印象があります。

写真にあるようにフロントエンドに関してはjavascriptによって書かれており、対してバックエンドはRuby on Railsで書かれています。

例えばスタンプについてはスタンプの追加の項目で説明がされますが、ボタンを定義する関数だったり、そのボタンがついたり消えたりするような表面的な部分についてはJavasciptで書かれています。しかしそのボタンを扱う上でそのボタンがついているのかついていないのかを知るためのデータを撮ってくる必要があります。さらには誰がそのスタンプを押しているのか合計するとどれくらいの人が押してくれているのかを知るためにはやはりデータを集めておく必要があります。

データベースの処理を扱っているのがバックエンドの部分です。これはRubyによって書かれています。ボタンが押されたあとにRubyの関数が呼び出されて、データベースが書き換えられるということです。

またこのデータベースに関してはymlファイルによって保存されています。ymlファイルというのはtxtファイルに近いもので文字を保存しておいてくれるものですが、データの保存に使われることが多いものです。

またファイルが収まっている領域について簡単にわかる範囲で説明しておくと、基本的に大部分のソースコードはappフォルダに入っています。その中のjavascriptフォルダがありフロントの部分はここに集約されています。調べていくときはjavascriptからとっかかると始めやすいかもしれません。

その中を探ってみると、actionsというフォルダが見つかります。これを見ると基本的なmastodonの機能について知ることができます。今回暑かったスタンプについてもfavourite.jsという形になっています。

ここにはfavouriteスタンプを押すときの基本的な関数が定義されてます。これらの関数がどこで使われているのか調べてみると、status_lists.jsで使われていることがわかります。このファイル名を見てもわかるように、favouriteだけではなく様々なスタンプの情報が集約されてきていることがわかります。

ここにインポートされてきている関数やエクスポートしている関数を調べてみてもjavascriptのフォルダからなかなか出てくることができませんでした。つながりがほとんど見えません。

javascript側からつながりを見つけることができなければ、Ruby側からつながりを探していくことにします。

appというフォルダの中にはserviceというフォルダがあります。明らかに怪しいので調べてみましょう。mastodonの機能を扱っているだろうRubyファイルが多く見つかります。例えばaccount_search_service.rbやdelete_account_service.rbのようにファイルが見つかります。この中にfavorite_service.rbもあります。これらのファイルの中にはcall関数がそれぞれ定義されており、これらのrubyファイルが関係する中で呼び出しが発生しているのではないかと推測することができます。

favourite_service.rbのファイルを覗いているとstatus_idなるものが扱われています。これについて検索をかけてみると膨大な量の検索結果が現れますがファイルにすると146ファイルであり、重要そうな部分を探してみると、schema.rbというファイルが見つかります。

このファイルを覗いてみると英語でこのファイルはデータベースの現在の状況から自動的に更新されると書いてあり、さらにはrailsがスキーマを定義するために使用するソースとも書いています。データベースについて変更を加えると勝手に更新してくれるということです。つまり必要なものを更新しておけばここにも反映されるということで、ここに必要なものは定義されているようです。

ここまでなんとなく手がかりを見つけて探していきましたが、どうしても知りたい関数についての情報が見つかってきません。これはRuby on Railsの使用によるものであると今回感じました。Ruby on RailsはWebアプリケーション開発に特化したフレームワークであり、必要な基盤や機能を提供してしまうソフトウェアになるため開発期間を短縮することができる一方でその機能の詳細が初めて見る人にはわからなくなってしまっているのだと思います。またRuby on Railsを用いていると、開発ブラウザを開きながら、コードの更新が行われると自動的にリロードが行われ、コードの変更が反映されるようになっています。開発をしていく中ではとてもありがたい機能になっています。

同様に用いられているフレームワークとしてreactが挙げられます。UIのパーツを作るためのライブラリとなっていて、ボタンやテキストボックスを多用するWebアプリケーションに有効なフレームワークと言われています。今回扱っているMastodonについても当てはまると言えます。